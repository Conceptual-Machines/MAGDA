name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build Docker image
      run: docker build -t magda-build .

    - name: Configure CMake in Docker
      run: |
        docker run --rm -v $PWD:/workspace magda-build \
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DMAGDA_BUILD_TESTS=ON

    - name: Build in Docker
      run: |
        docker run --rm -v $PWD:/workspace magda-build \
          bash -c "echo 'Building with $(nproc) cores...' && cmake --build build --config Debug -j$(nproc) -- -v"

    - name: Check build artifacts
      run: |
        echo "Checking build directory structure:"
        ls -la build/tests/ || echo "tests directory not found"
        find build -name "magda_tests" -type f || echo "magda_tests executable not found"

    - name: Run tests in Docker
      run: |
        if [ -f build/tests/magda_tests ]; then
          echo "Running tests..."
          docker run --rm -v $PWD:/workspace magda-build \
            ./build/tests/magda_tests
        else
          echo "❌ Tests executable not found at build/tests/magda_tests"
          echo "Build directory contents:"
          find build -type f -name "*test*" || true
          exit 1
        fi

    - name: Test summary
      if: success()
      run: |
        echo "✅ Build and tests completed successfully on Linux"

  code-quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build Docker image
      run: docker build -t magda-build .

    - name: Check code formatting
      run: |
        docker run --rm -v $PWD:/workspace magda-build \
          bash -c "
            echo 'Checking code formatting with clang-format...'
            find magda/daw magda/agents tests -name '*.cpp' -o -name '*.hpp' -o -name '*.h' 2>/dev/null | \
              xargs clang-format --dry-run --Werror 2>&1 | tee format-check.log || true

            if grep -q 'warning:' format-check.log; then
              echo '❌ Format check found issues'
              echo 'Run make format to fix formatting issues'
              exit 1
            else
              echo '✅ Format check passed!'
            fi
          "
